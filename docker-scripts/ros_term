#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n\t'

# Generates a shell inside the ROS container.

DIR="$(realpath "$(dirname "$0")")"/..

sudo docker build "$DIR/ros" -t lunabotics-2023-ros

echo "Add '129.138.xxx.xxx  jetson' to /etc/hosts for network support"

# Function to find the joystick path.
param=""
for ((c=32; c>=0; c--)); do
    file="/dev/input/js$c"
    if [ -e $file ]; then
        param="--device=$file"
    fi
done

ip=$(ip addr | grep 'state UP' -A2 | tail -n1 | awk '{print $2}' | cut -f1  -d'/')

#    -e ROS_IP=$ip
#    -e ROS_MASTER_URI=http://jetson:11311
params=(
    --rm
    -it
    --net=host
    -v $DIR:$DIR
    -e DISPLAY
    -v /tmp/.X11-unix:/tmp/.X11-unix:rw
    -v /dev:/dev:rw
    --device-cgroup-rule "c 81:* rmw"
    --device-cgroup-rule "c 189:* rmw"
    $param
)

sudo docker run \
    "${params[@]}" \
    lunabotics-2023-ros \
    sh -c "
    cd $PWD
    export HOME="$HOME"
    export PS1='\u@\h:\w\$ '
    [ -e $DIR/ros/catkin_ws/devel/setup.sh ] && . $DIR/ros/catkin_ws/devel/setup.sh
    bash
    "

# ROS might create files owned by root here; it'll cause all kinds of
# problems with git.
sudo chown -R "$(id -u):$(id -g)" "$DIR"
